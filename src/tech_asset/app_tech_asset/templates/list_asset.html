{% extends 'base.html' %}
{% block content %}
{% load static %}
<script src="{% static 'js/jsQR.js' %}"></script>
<script>
    console.log("jsQR script loaded: ", typeof jsQR !== 'undefined');
</script>


<div class="container mt-3">
    <div class="accordion" id="accBtns">
        <div class="">
            
<!-- ===================================== TOP BUTTONS ============================= -->

            <div class="row">
                <div class="col-3">
                    <div class="card mb-3" type="button" data-bs-toggle="collapse" data-bs-target="#collNewAsset" aria-expanded="false" aria-controls="collNewAsset">
                        <div class="card-body">
                            <h4 id="headNewAsset">
                                Novo Ativo
                            </h4>
                        </div>
                    </div>
                </div>
                <div class="col-3">
                    <div class="card mb-3" type="button" data-bs-toggle="collapse" data-bs-target="#collSector" aria-expanded="false" aria-controls="collSector">
                        <div class="card-body">
                            <h4 id="headSector">
                                Setores e Kits
                            </h4>
                        </div>
                    </div>
                </div>
                <div class="col-3">
                    <div class="card mb-3" type="button" data-bs-toggle="modal" data-bs-target="#filterModal">
                        <div class="card-body">
                            <h4 id="headKit">
                                Busca Avançada
                            </h4>
                        </div>
                    </div>
                </div>
                <div class="col-3">
                    <div class="card mb-3" id="scanQrCodeBtn" type="button" data-bs-toggle="modal" data-bs-target="#qrCodeScanModal">
                        <div class="card-body">
                            <h4 id="headingThree">
                                Escanear QR Code
                            </h4>
                        </div>
                    </div>
                </div>                
                
            </div>

<!-- ===================================== NEW ASSET ============================= -->

            <div id="collNewAsset" class="accordion-collapse collapse mb-3" aria-labelledby="headNewAsset" data-bs-parent="#accBtns">
                <div class="card">
                        <div class="card-header">
                            Novo Ativo
                        </div>
                        <div class="card-body">
                            {% if messages %}
                                <div class="alert alert-info">
                                    {% for message in messages %}
                                        <p>{{ message }}</p>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <form method="post" action="{% url 'new_asset' %}">
                                {% csrf_token %}
                                <div class="row">
                                    <div class="col-md-12">
                                        <label for="id_name">Nome:</label>
                                        <input type="text" name="name" id="id_name" class="form-control" maxlength="50" required>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-3">
                                        <label for="id_category">Categoria:</label>
                                        <select name="category" id="id_category" class="form-control" required>
                                            {% for category in categories %}
                                            <option value="{{ category.id }}">{{ category.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="id_subcategory">SubCategoria:</label>
                                        <select name="subcategory" id="id_subcategory" class="form-control">

                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="id_sector">Setor:</label>
                                        <select name="sector" id="id_sector" class="form-control" required>
                                            {% for sector in sectors %}
                                            <option value="{{ sector.id }}">{{ sector.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="id_subsector">SubSetor:</label>
                                        <select name="subsector" id="id_subsector" class="form-control">

                                        </select>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-3">
                                        <label for="id_rental_company">Empresa:</label>
                                        <select name="rental_company" id="id_rental_company" class="form-control" required>
                                            {% for rental_company in rental_companies %}
                                            <option value="{{ rental_company.id }}">{{ rental_company.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="id_internal_code1">{% if global_settings.internalcode1 %}{{ global_settings.internal_code1 }}{% else %} Codigo Interno 1 {% endif %}:</label>
                                        <input type="text" name="internal_code1" id="id_internal_code1" class="form-control" maxlength="50">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="id_internal_code2">{% if global_settings.internalcode2 %}{{ global_settings.internal_code2 }}{% else %} Codigo Interno 2 {% endif %}:</label>
                                        <input type="text" name="internal_code2" id="id_internal_code2" class="form-control" maxlength="50">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="id_internal_code3">{% if global_settings.internalcode3 %}{{ global_settings.internal_code3 }}{% else %} Codigo Interno 3 {% endif %}:</label>
                                        <input type="text" name="internal_code3" id="id_internal_code3" class="form-control" maxlength="50">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-3">
                                        <label for="id_serial_number">Numero de Série:</label>
                                        <input type="text" name="serial_number" id="id_serial_number" class="form-control" maxlength="50">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="id_brand">Marca:</label>
                                        <input type="text" name="brand" id="id_brand" class="form-control" maxlength="50">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="id_mac_address">MAC Address:</label>
                                        <input type="text" name="mac_address" id="id_mac_address" class="form-control" maxlength="50">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="id_windows_license">Licença Windows:</label>
                                        <input type="text" name="windows_license" id="id_windows_license" class="form-control" maxlength="50">
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary mt-3">Concluir</button>
                            </form>
                            
                            <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
                            <script>
                                $(document).ready(function(){
                                    $('#id_sector').change(function(){
                                        var sector_id = $(this).val();
                                        $.ajax({
                                            url: '/get_subsectors/',
                                            data: {'sector_id': sector_id},
                                            dataType: 'json',
                                            success: function(data){
                                                $('#id_subsector').empty();
                                                $.each(data.subsectors, function(index, subsector){
                                                    $('#id_subsector').append('<option value="' + subsector.id + '">' + subsector.name + '</option>');
                                                });
                                            },
                                            error: function(xhr, status, error) {
                                                console.error("Error:", error);
                                            }
                                        });
                                    });
                                    $('#id_category').change(function(){
                                        var category_id = $(this).val();
                                        $.ajax({
                                            url: '/get_subcategories/',
                                            data: {'category_id': category_id},
                                            dataType: 'json',
                                            success: function(data){
                                                $('#id_subcategory').empty();
                                                $.each(data.subcategories, function(index, subcategory){
                                                    $('#id_subcategory').append('<option value="' + subcategory.id + '">' + subcategory.name + '</option>');
                                                });
                                            },
                                            error: function(xhr, status, error) {
                                                console.error("Error:", error);
                                            }
                                        });
                                    });
                                });
                            </script>
    
                        </div>
                    
                </div>
            </div>

<!-- ===================================== SECTORS AND KITS ============================= -->

            <div id="collSector" class="accordion-collapse collapse mb-3" aria-labelledby="headSector" data-bs-parent="#accBtns">
                <div class="row">
                    <div class="col-8">
                        <div class="card">
                            <div class="card-header">
                                Setores e Subsetores
                            </div>
                            <div class="card-body">

                                <div class="row">
                                    <div class="col-4">
                                        <form method="post" class="mb-3" action="{% url 'new_sector' %}">
                                            {% csrf_token %}
                                            <div class="input-group">
                                                {{ sectorform.Novo_Setor }}
                                                <button type="submit" class="btn btn-primary"><i class="nf nf-cod-add"></i></button>
                                            </div>
                                        </form>
                                        <div class="sector-list">
                                            <div id="simple-list-example" class="d-flex flex-column gap-2 simple-list-example-scrollspy">
                                                <ul class="list-group" id="sector-list">
                                                    {% for sector in sector_list %}
                                                    <li class="list-group-item d-flex justify-content-between align-items-center" onclick="showSubsectors('{{ sector.id }}')">
                                                        {{ sector.name }}
                                                        <a href="#" class="btn btn-outline-danger btn-sm" onclick="deleteSector('{{ sector.id }}', event)"><i class="nf nf-md-delete"></i></a>
                                                    </li>
                                                    {% endfor %}
                                                </ul>  
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-8">
                                        <form method="post" class="mb-3" action="{% url 'new_subsector' %}">
                                            {% csrf_token %}                                    
                                            <div class="input-group mb-3">
                                                {{ subsectorform.parent }}
                                                {{ subsectorform.Novo_SubSetor }}
                                                <button type="submit" class="btn btn-primary"><i class="nf nf-cod-add"></i></button>
                                            </div>
                                        </form>
                                        <div class="sector-list">
                                            <div data-bs-spy="scroll" data-bs-target="#simple-list-example" data-bs-offset="0" data-bs-smooth-scroll="true" class="scrollspy-example" tabindex="0">
                                                <ul class="list-group" id="subsector-list">
                                                    <!-- Subsetores serão inseridos aqui -->
                                                </ul>  
                                            </div>
                                        </div>
                                    </div>
                                    </div>



                            </div>
                        </div>
                        <script>
                            // Adiciona uma mensagem de depuração para verificar se o script está sendo carregado
                            console.log("Script carregado");

                            // Criar um objeto vazio para armazenar setores
                            const sectors = {};

                            // Adiciona setores ao objeto com base nos dados do template
                            {% for sector in sector_list %}
                            sectors['{{ sector.id }}'] = [
                                {% for subsector in sector.subsector_set.all %}
                                {id: '{{ subsector.id }}', name: '{{ subsector.name }}'},
                                {% endfor %}
                            ];
                            {% endfor %}

                            // Adiciona uma mensagem de depuração para verificar se os setores foram carregados corretamente
                            console.log("Setores carregados:", sectors);

                            function showSubsectors(sectorId) {
                                // Adiciona uma mensagem de depuração para verificar se a função está sendo chamada
                                console.log("showSubsectors chamado para o setor:", sectorId);

                                const subsectorList = document.getElementById('subsector-list');
                                subsectorList.innerHTML = ''; // Limpar lista de subsetores

                                if (sectors[sectorId]) {
                                    sectors[sectorId].forEach(subsector => {
                                        const li = document.createElement('li');
                                        li.className = 'list-group-item d-flex justify-content-between align-items-center';
                                        li.textContent = subsector.name;

                                        // Cria o botão de exclusão
                                        const deleteButton = document.createElement('a');
                                        deleteButton.className = 'btn btn-outline-danger btn-sm';
                                        deleteButton.innerHTML = '<i class="nf nf-md-delete"></i>';
                                        deleteButton.href = '#';
                                        deleteButton.onclick = function(event) {
                                            event.preventDefault();
                                            deleteSubsector(subsector.id);
                                        };

                                        // Adiciona o botão de exclusão ao item da lista
                                        li.appendChild(deleteButton);
                                        subsectorList.appendChild(li);
                                    });
                                } else {
                                    console.log("Nenhum subsetor encontrado para o setor:", sectorId);
                                }
                            }

                            function deleteSubsector(subsectorId) {
                                console.log("Deletar subsector com ID:", subsectorId);

                                // Envia uma solicitação de exclusão para o servidor (exemplo de como isso pode ser feito com AJAX)
                                fetch(`/delete_subsector/${subsectorId}/`, {
                                    method: 'DELETE',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'X-CSRFToken': '{{ csrf_token }}' // Certifique-se de que o CSRF token está disponível
                                    }
                                })
                                .then(response => {
                                    if (response.ok) {
                                        console.log("Subsector deletado com sucesso:", subsectorId);
                                        // Remover o subsetor do DOM
                                        document.querySelector(`#subsector-list li[data-id='${subsectorId}']`).remove();
                                    } else {
                                        console.log("Erro ao deletar o subsector:", subsectorId);
                                    }
                                })
                                .catch(error => {
                                    console.error("Erro ao enviar a solicitação de exclusão:", error);
                                });
                            }

                            function deleteSector(sectorId, event) {
                                event.preventDefault(); // Previne o comportamento padrão do link
                                event.stopPropagation(); // Impedir que o clique no botão de exclusão acione a função showSubsectors
                                console.log("Deletar setor com ID:", sectorId);

                                // Envia uma solicitação de exclusão para o servidor (exemplo de como isso pode ser feito com AJAX)
                                fetch(`/preferences/sector/delete/${sectorId}/`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'X-CSRFToken': '{{ csrf_token }}' // Certifique-se de que o CSRF token está disponível
                                    }
                                })
                                .then(response => {
                                    if (response.ok) {
                                        console.log("Setor deletado com sucesso:", sectorId);
                                        // Remover o setor do DOM
                                        document.querySelector(`#sector-list li[onclick='showSubsectors("${sectorId}")']`).remove();
                                    } else {
                                        console.log("Erro ao deletar o setor:", sectorId);
                                    }
                                })
                                .catch(error => {
                                    console.error("Erro ao enviar a solicitação de exclusão:", error);
                                });
                            }
                        </script>
                    </div>
                    <div class="col-4">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                Kits
                                <button type="button" class="btn btn-sm btn-outline-secondary ms-auto ms-3" data-bs-toggle="modal" data-bs-target="#newkitModal">
                                    Novo Kit
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="kit-list">
                                    <div class="accordion" id="accordionKit">
                                        {% for kit in kit_list %}
                                            <div class="accordion-item">
                                                <h2 class="accordion-header">
                                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ kit.id }}" aria-expanded="false" aria-controls="collapse{{ kit.id }}">
                                                        {{ kit.id }} - {{ kit.name }} - {{ kit.sectors }} | {{ kit.subsectors }}
                                                    </button>
                                                </h2>
                                                <div id="collapse{{ kit.id }}" class="accordion-collapse collapse" data-bs-parent="#accordionKit">
                                                    <div class="accordion-body">
                                                        <ul class="list-group">
                                                            <li class="list-group-item">
                                                                <a href="" class="btn btn-sm btn-secondary"><i class="nf nf-md-history"></i></a>
                                                                <a href="" class="btn btn-sm btn-secondary"><i class="nf nf-md-playlist_edit"></i></a>
                                                                <a class="btn btn-sm btn-secondary" data-bs-toggle="modal" data-bs-target="#transferKitModal{{ kit.id }}"><i class="nf nf-fa-arrow_right_arrow_left"></i></a>
                                                                <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#deleteKitModal{{ kit.id }}"><i class="nf nf-md-delete"></i></button>
                                                            </li>
                                                            {% for asset in kit.assets.all %}
                                                            <li class="list-group-item">{{asset.id}} - {{ asset.name }} - {{asset.internal_code1}}</li>
                                                            {% endfor %}
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Transfer Kit Modal ============================================================================================================================-->

                                            <div class="modal fade" id="transferKitModal{{ kit.id }}" tabindex="-1" aria-labelledby="transferKitModalLabel{{ kit.id }}" aria-hidden="true">
                                                <div class="modal-dialog">
                                                    <div class="modal-content">
                                                        <div class="modal-header">
                                                            <h1 class="modal-title fs-5" id="transferKitModalLabel{{ kit.id }}">Transfer {{ kit.name }}</h1>
                                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                        </div>
                                                        <div class="modal-body">
                                                            <form method="post" action="{% url 'transfer_kit' kit.id %}">
                                                                {% csrf_token %}
                                                                <div class="modal-body">
                                                                    <div class="row">
                                                                        <div class="col-6">
                                                                            <label for="id_sector_t_{{kit.id}}">Setor:</label>
                                                                            <select name="sector" id="id_sector_t_{{kit.id}}" class="form-control" required>
                                                                                {% for sector in sectors %}
                                                                                <option value="{{ sector.id }}">{{ sector.name }}</option>
                                                                                {% endfor %}
                                                                            </select>
                                                                            {% if kit.sector %}<p>Atual: {{ kit.sector }}</p>{% endif %}
                                                                        </div>
                                                                        <div class="col-6">
                                                                            <label for="id_subsector_t_{{kit.id}}">SubSetor:</label>
                                                                            <select name="subsector" id="id_subsector_t_{{kit.id}}" class="form-control">
                                                                                {% for subsector in subsectors %}
                                                                                <option value="{{ subsector.id }}">{{ subsector.name }}</option>
                                                                                {% endfor %}
                                                                            </select>
                                                                            {% if kit.subsector %}<p>Atual: {{ kit.subsector }}</p>{% endif %}
                                                                        </div>
                                                                    </div>
                                                                </div>             
                                                                <div class="modal-footer">
                                                                    <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Fechar</button>   
                                                                    <button type="submit" class="btn btn-sm btn-primary">Concluir</button>
                                                                </div>
                                                            </form>           
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Delete Modal =================================================================================================================-->

                                            <div class="modal fade" id="deleteKitModal{{ kit.id }}" tabindex="-1" aria-labelledby="deleteKitModalLabel{{ kit.id }}" aria-hidden="true">
                                                <div class="modal-dialog">
                                                    <div class="modal-content">
                                                        <div class="modal-header">
                                                            <h1 class="modal-title fs-5" id="deleteKitModalLabel{{ kit.id }}">Deseja remover {{ kit.name }}</h1>
                                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                        </div>
                                                        <div class="modal-body">
                                                            <form method="post" action="{% url 'delete_kit' kit.id %}">
                                                                {% csrf_token %}
                                                                <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Close</button>
                                                                <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                                                            </form>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            



                                        {% endfor %} 
                                    </div>
                                </div>  
                                <!-- Modal -->
                                <div class="modal fade" id="newkitModal" tabindex="-1" aria-labelledby="newkitModalLabel" aria-hidden="true">
                                    <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                        <h1 class="modal-title fs-5" id="newkitModalLabel">New Kit</h1>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <form method="post" action="{% url 'new_kit' %}">
                                                {% csrf_token %}
                                                {{ kitform.name }}
                                                <input type="text" id="asset-search" class="form-control mb-3" placeholder="Pesquisar ativos">
                                                
                                                <div id="asset-list" class="form-check">
                                                    {% for asset in asset_list %}
                                                        <div class="form-check">
                                                            <input class="form-check-input asset-checkbox" type="checkbox" name="assets" value="{{ asset.id }}" id="asset{{ asset.id }}">
                                                            <label class="form-check-label" for="asset{{ asset.id }}">
                                                            {{asset.internal_code1}} - {{asset.name}}
                                                            </label>
                                                        </div>
                                                    {% endfor %}
                                                </div>
                                    
                                            </div>
                                            <div class="modal-footer">
                                            <button type="submit" class="btn btn-primary">Enviar</button>
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                            </form>
                                            <script>
                                                document.addEventListener("DOMContentLoaded", function() {
                                                    const searchInput = document.getElementById("asset-search");
                                                    const assetCheckboxes = document.querySelectorAll(".asset-checkbox");
                                        
                                                    searchInput.addEventListener("input", function() {
                                                        const filter = searchInput.value.toLowerCase();
                                                        assetCheckboxes.forEach(checkbox => {
                                                            const label = checkbox.nextElementSibling.textContent.toLowerCase();
                                                            if (label.includes(filter)) {
                                                                checkbox.parentElement.style.display = "";
                                                            } else {
                                                                checkbox.parentElement.style.display = "none";
                                                            }
                                                        });
                                                    });
                                                });
                                            </script>
                                        </div>
                                    </div>
                                    </div>
                                </div>  
                                
                                
                            </div>
                        </div>
                    </div>
                </div>
            </div>

<!-- ===================================== FILTERS MODAL ============================= -->

            <!-- Modal -->
            <div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                    <h5 class="modal-title" id="filterModalLabel">Filtrar Assets</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                    <form id="filterForm">
                        <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                            <input type="text" class="form-control" id="name" name="name" placeholder="Nome">
                            </div>
                            <div class="mb-3">
                            <input type="text" class="form-control" id="sector" name="sector" placeholder="Setor">
                            </div>
                            <div class="mb-3">
                            <input type="text" class="form-control" id="subsector" name="subsector" placeholder="Subsetor">
                            </div>
                            <div class="mb-3">
                            <input type="text" class="form-control" id="category" name="category" placeholder="Categoria">
                            </div>
                            <div class="mb-3">
                            <input type="text" class="form-control" id="subcategory" name="subcategory" placeholder="SubCategoria">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                            <input type="text" class="form-control" id="rentalcompany" name="rentalcompany" placeholder="Empresa">
                            </div>
                            <div class="mb-3">
                            <input type="text" class="form-control" id="internalcode1" name="internalcode1" placeholder="{{global_settings.internalcode01}}">
                            </div>
                            <div class="mb-3">
                            <input type="text" class="form-control" id="internalcode2" name="internalcode2" placeholder="{{global_settings.internalcode02}}">
                            </div>
                            <div class="mb-3">
                            <input type="text" class="form-control" id="internalcode3" name="internalcode3" placeholder="{{global_settings.internalcode03}}">
                            </div>
                        </div>
                        </div>
                    </form>
                    </div>
                    <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-primary" onclick="submitFilterForm()">Filtrar</button>
                    </div>
                </div>
                </div>    
                    <script>
                        function submitFilterForm() {
                            const form = document.getElementById('filterForm');
                            const formData = new FormData(form);
                            
                            // Convert FormData to URL-encoded string
                            const params = new URLSearchParams(formData);
                            
                            // Redirect to the filter view with the query parameters
                            window.location.href = `/filter_assets?${params.toString()}`;
                        }
                    </script>
                </div>
<!-- ===================================== QRCODE SCAN ============================= -->
     
            <!-- Modal -->
            <div class="modal fade" id="qrCodeScanModal" tabindex="-1" aria-labelledby="qrCodeScanModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                    <h1 class="modal-title fs-5" id="qrCodeScanModalLabel">Escanear QR-Code</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <style>
                            .video-container {
                                display: flex;
                                justify-content: center;
                                align-items: center;
                                flex-direction: column;
                                height: 100%;
                            }
                            #video {
                                display: none;
                            }
                            #canvas {
                                display: none;
                                width: 100%;
                            }
                        </style>
                            <!-- <button id="scanQrCodeBtn" class="btn btn-primary mb-3">Iniciar</button> -->
                            <div class="video-container">
                                <video id="video" width="300" height="200"></video>
                            </div>    
                            <canvas id="canvas"></canvas>
                            <div id="qrResult"></div>
                        <script>
                    document.addEventListener('DOMContentLoaded', (event) => {
                        const qrCodeScanModal = document.getElementById('qrCodeScanModal');
                        qrCodeScanModal.addEventListener('shown.bs.modal', function () {
                            startQrCodeScanner();
                        });

                        function startQrCodeScanner() {
                            const video = document.getElementById('video');
                            const canvasElement = document.getElementById('canvas');
                            const canvas = canvasElement.getContext('2d');
                            const qrResult = document.getElementById('qrResult');

                            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } }).then(function (stream) {
                                video.srcObject = stream;
                                video.setAttribute('playsinline', true); // iOS safari bullshit
                                video.style.display = 'block';
                                video.play();
                                requestAnimationFrame(tick);
                            }).catch(function (err) {
                                console.error("Error accessing camera: ", err);
                                qrResult.textContent = "ERRO AO ACESSAR A CAMERA: " + err;
                            });

                            function tick() {
                                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                                    canvasElement.height = video.videoHeight;
                                    canvasElement.width = video.videoWidth;
                                    canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
                                    const imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
                                    const code = jsQR(imageData.data, imageData.width, imageData.height, {
                                        inversionAttempts: 'dontInvert',
                                    });
                                    if (code) {
                                        drawLine(code.location.topLeftCorner, code.location.topRightCorner, '#FF3B58');
                                        drawLine(code.location.topRightCorner, code.location.bottomRightCorner, '#FF3B58');
                                        drawLine(code.location.bottomRightCorner, code.location.bottomLeftCorner, '#FF3B58');
                                        drawLine(code.location.bottomLeftCorner, code.location.topLeftCorner, '#FF3B58');
                                        qrResult.textContent = "QR Code Data: " + code.data;
                                        console.log("QR Code Data: ", code.data);
                                        handleQrCodeData(code.data);
                                        stopVideo();
                                    } else {
                                        qrResult.textContent = "Não foi detectado nenhum QR Code.";
                                        requestAnimationFrame(tick);
                                    }
                                } else {
                                    requestAnimationFrame(tick);
                                }
                            }

                            function drawLine(begin, end, color) {
                                canvas.beginPath();
                                canvas.moveTo(begin.x, begin.y);
                                canvas.lineTo(end.x, end.y);
                                canvas.lineWidth = 4;
                                canvas.strokeStyle = color;
                                canvas.stroke();
                            }

                            function stopVideo() {
                                video.srcObject.getTracks().forEach(track => track.stop());
                                video.style.display = 'none';
                            }

                            function handleQrCodeData(data) {
                                const idMatch = data.match(/ID:\s*(\d+)/);
                                if (idMatch && idMatch[1]) {
                                    const assetId = idMatch[1];
                                    window.location.href = `/asset/view/${assetId}/`;
                                } else {
                                    qrResult.textContent = "ID não encontrado no QR Code.";
                                }
                            }
                        }
                    });
                        </script>
                    </div>
                    <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    </div>
                </div>
                </div>
            </div>

        </div>
    </div>

<!--==========================================
=                                            =
=                                            =
=              LISTA DE ATIVOS               =
=                                            =
=                                            =
===========================================-->

    <div class="card mb-3">
        <div class="card-header">
            Lista de Ativos
        </div>
        <div class="card-body">

            <table class="table table-sm">
                <tr>
                    <th scope="col">ID</th>
                    <th scope="col">{{global_settings.internalcode01}}</th>
                    <th scope="col">Nome</th>
                    <th scope="col">Setor</th>
                    <th scope="col">Sub-Setor</th>
                    <th scope="col">Categoria</th>
                    <th scope="col">SubCategoria</th>
                    <th scope="col">Ações</th>
                </tr>
                {% for asset in page_obj %}
                <tr>
                    <td  onclick="window.location.href='{% url 'view_asset' asset.id %}'">{{ asset.id }}</td>
                    <td  onclick="window.location.href='{% url 'view_asset' asset.id %}'">{{ asset.internal_code1 }}</td>
                    <td  onclick="window.location.href='{% url 'view_asset' asset.id %}'">{{ asset.name }}</td>
                    <td  onclick="window.location.href='{% url 'view_asset' asset.id %}'">{% if asset.sector %}{{ asset.sector }}{% endif %}</td>
                    <td  onclick="window.location.href='{% url 'view_asset' asset.id %}'">{% if asset.subsector %}{{ asset.subsector }}{% endif %}</td>
                    <td  onclick="window.location.href='{% url 'view_asset' asset.id %}'">{% if asset.category %}{{ asset.category }}{% endif %}</td>
                    <td  onclick="window.location.href='{% url 'view_asset' asset.id %}'">{% if asset.subcategory %}{{ asset.subcategory }}{% endif %}</td>
                    <td>
                        <a href="{% url 'history_asset' asset.id %}" class="btn btn-sm btn-secondary"><i class="nf nf-md-history"></i></a>
                        <a href="{% url 'edit_asset' asset.id %}" class="btn btn-sm btn-secondary"><i class="nf nf-md-playlist_edit"></i></a>
                        <button class="btn btn-secondary btn-sm" id="generateQR{{asset.id}}" data-bs-toggle="modal" data-bs-target="#qrModal{{ asset.id }}"><i class="nf nf-md-qrcode"></i></button>
                        <a class="btn btn-sm btn-secondary" data-bs-toggle="modal" data-bs-target="#transferModal{{ asset.id }}"><i class="nf nf-fa-arrow_right_arrow_left"></i></a>
                        <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal{{ asset.id }}"><i class="nf nf-md-delete"></i></button>
                    </td>
                </tr>

                <!-- Transfer Modal ============================================================================================================================-->

                <div class="modal fade" id="transferModal{{ asset.id }}" tabindex="-1" aria-labelledby="transferModalLabel{{ asset.id }}" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h1 class="modal-title fs-5" id="transferModalLabel{{ asset.id }}">Transfer {{ asset.name }}</h1>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form method="post" action="{% url 'transfer_asset' asset.id %}">
                                    {% csrf_token %}
                                    <div class="modal-body">
                                        <div class="row">
                                            <div class="col-6">
                                                <label for="id_sector">Setor:</label>
                                                <select name="sector" id="id_sector_t_{{asset.id}}" class="form-control" required>
                                                    {% for sector in sectors %}
                                                    <option value="{{ sector.id }}">{{ sector.name }}</option>
                                                    {% endfor %}
                                                </select>
                                                {% if asset.sector %}<p>Atual: {{ asset.sector }}</p>{% endif %}
                                            </div>
                                            <div class="col-6">
                                                <label for="id_subsector">SubSetor:</label>
                                                <select name="subsector" id="id_subsector_t_{{asset.id}}" class="form-control">
                                                    
                                                </select>
                                                {% if asset.subsector %}<p>Atual: {{ asset.subsector }}</p>{% endif %}
                                            </div>
                                        </div>
                                    </div>             
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Fechar</button>   
                                        <button type="submit" class="btn btn-sm btn-primary">Concluir</button>
                                    </div>
                                </form>           
                            </div>
                        </div>
                    </div>
                </div>

                <!-- QR Modal ===========================================================================================================================-->

                <div class="modal fade" id="qrModal{{ asset.id }}" tabindex="-1" aria-labelledby="qrModalLabel{{ asset.id }}" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h1 class="modal-title fs-5" id="qrModalLabel{{ asset.id }}">QR-Code {{ asset.name }}</h1>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div id="qrtag{{ asset.id }}">
                                    <div  class="row">
                                        <div class="col-12 text-center">
                                        </div>
                                        <div class="col-auto text-center">
                                            
                                            <div id="qrCodeContainer{{asset.id}}"></div>
                                        </div>
                                        <div class="col">
                                            <img src="{% static 'img/hegvses.png' %}" class="logo_print">
                                            <p><b>GESTÃO DE ATIVOS DE TI</b>
                                            <br><b style="font-size: 26px;">{{ asset.internal_code1}}</b>
                                            <br>EMPRESA: {{ asset.rental_company}}
                                            <br>Ramal: 374</p>
                                        </div>
                                    </div>
                                </div>
                                <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
                                <script>
                                    $(document).ready(function() {
                                        $('#generateQR{{asset.id}}').click(function() {
                                            $.ajax({
                                                type: 'GET',
                                                url: '{% url "generate_qr_code" asset.id %}',
                                                xhrFields: {
                                                    responseType: 'blob'
                                                },
                                                success: function(data) {
                                                    var reader = new FileReader();
                                                    reader.onload = function(e) {
                                                        $('#qrCodeContainer{{asset.id}}').html('<img src="' + e.target.result + '" alt="QR Code" class="qrcode">');
                                                    }
                                                    reader.readAsDataURL(data);
                                                },
                                                error: function(xhr, status, error) {
                                                    console.error("Error:", error);
                                                }
                                            });
                                        });
                                    });

                                    function printDiv(divId) {
                                        var content = document.getElementById(divId).innerHTML;
                                        var originalContent = document.body.innerHTML;

                                        document.body.innerHTML = content;

                                        window.print();

                                        document.body.innerHTML = originalContent;
                                    }
                                </script>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                                <button type="button" class="btn btn-primary" onclick="printDiv('qrtag{{ asset.id }}')">Imprimir</button>
                            </div>
                        </div>
                    </div>
                </div>          
                <script>
                    $(document).ready(function(){
                        console.log("Document ready");
                        $('#id_sector_t_{{asset.id}}').change(function(){
                            console.log("Setor change event");
                            var sector_id = $(this).val();
                            $.ajax({
                                url: '/get_subsectors/',
                                data: {'sector_id': sector_id},
                                dataType: 'json',
                                success: function(data){
                                    console.log("Subsectors received:", data.subsectors);
                                    $('#id_subsector_t_{{asset.id}}').empty();
                                    $.each(data.subsectors, function(index, subsector){
                                        $('#id_subsector_t_{{asset.id}}').append('<option value="' + subsector.id + '">' + subsector.name + '</option>');
                                    });
                                },
                                error: function(xhr, status, error) {
                                    console.error("Error:", error);
                                }
                            });
                        });
                    });
                </script>

                <!-- Delete Modal =================================================================================================================-->

                <div class="modal fade" id="deleteModal{{ asset.id }}" tabindex="-1" aria-labelledby="deleteModalLabel{{ asset.id }}" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h1 class="modal-title fs-5" id="deleteModalLabel{{ asset.id }}">Deseja remover {{ asset.name }}</h1>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form method="post" action="{% url 'delete_asset' asset.id %}">
                                    {% csrf_token %}
                                    <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Close</button>
                                    <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>


                {% endfor%}
            </table>
            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center">
                    {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}" aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>
                    {% else %}
                    <li class="page-item disabled">
                        <span class="page-link">&laquo;</span>
                    </li>
                    {% endif %}
                    {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                    <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                    <li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
                    {% endif %}
                    {% endfor %}
                    {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}" aria-label="Next">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                    {% else %}
                    <li class="page-item disabled">
                        <span class="page-link">&raquo;</span>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
    </div>
    
</div>






{% endblock %}